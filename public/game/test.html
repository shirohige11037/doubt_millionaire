<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Animation Test Scene</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
      }
      #area {
        position: relative;
        /* Canvasの固定サイズに合わせて幅と高さを設定 */
        width: 500px;
        height: 1000px;
        border: 1px solid #ccc;
        overflow: hidden;
        background-color: #333; /* 背景色の確認用 */
      }
      #gameScene {
        display: block;
        /* setDispSize() によってサイズが調整されます */
      }
      .controls {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="area">
      <canvas id="gameScene"></canvas>
    </div>

    <div class="controls">
      <button id="p1Play">P1: 場に出す (選択中)</button>
      <button id="p2Play">P2: 場に出す (2枚/自動循環)</button>
    </div>

    <script type="module">
      // anim.js から必要な関数をインポート
      import {
        generateCardData,
        initCanvas,
        initCard,
        mouseClick,
        mouseHover,
        playSelectedCard1,
        playSelectedCard2,
        setDispSize,
      } from "./anim.js";

      // =======================================================
      // 初期化ロジック
      // =======================================================

      // プレイヤー1の初期手札データ
      const PLAYER_HAND_DATA = generateCardData(12);

      document.addEventListener("DOMContentLoaded", () => {
        // 1. ⭐️ Canvasを初期化し、グローバルオブジェクト (window.opponentCardListsなど) を作成
        //    この呼び出しで 'getContext' エラーと、後続の 'hand2' エラーの両方を回避する準備が整う
        initCanvas(200);

        // 2. ✅ グローバルオブジェクトが定義された後でデータを設定

        // P2の場に出すグループデータ (2枚, 3枚, 1枚を順番に出すシミュレーション)
        window.playedCardGroups = {
          p2: [
            generateCardData(2),
            generateCardData(3),
            generateCardData(1),
          ],
        };
        window.playedCardIndex = { p2: 0 };

        // P2の手札枚数シミュレーション (window.opponentCardListsがinitCanvasで初期化後に設定)
        window.opponentCardLists.hand2 = generateCardData(20);

        // 3. その他の初期化処理

        // 描画サイズの初期設定
        setDispSize();

        // プレイヤーの手札を初期化
        initCard(PLAYER_HAND_DATA);

        // イベントリスナーの設定
        mouseHover();
        mouseClick();

        // 初期描画を開始
        window.animateAndDraw();

        // =======================================================
        // UI イベントリスナーの設定
        // =======================================================

        document.getElementById("p1Play").addEventListener(
          "click",
          () => {
            playSelectedCard1();
          },
        );

        document.getElementById("p2Play").addEventListener(
          "click",
          () => {
            // playSelectedCard2 は内部で window.playedCardGroups を参照する
            playSelectedCard2();
          },
        );

        // ウィンドウサイズ変更時にCanvasサイズを調整
        window.addEventListener("resize", setDispSize);
      });
    </script>
  </body>
</html>
